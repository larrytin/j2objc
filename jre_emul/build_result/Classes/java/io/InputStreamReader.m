//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: apache_harmony/classlib/modules/luni/src/main/java/java/io/InputStreamReader.java
//
//  Created by retechretech on 13-9-4.
//

#include "IOSByteArray.h"
#include "IOSCharArray.h"
#include "IOSClass.h"
#include "java/io/ByteArrayOutputStream.h"
#include "java/io/IOException.h"
#include "java/io/InputStream.h"
#include "java/io/InputStreamReader.h"
#include "java/io/UnsupportedEncodingException.h"
#include "java/lang/IndexOutOfBoundsException.h"
#include "java/lang/Math.h"
#include "java/lang/NullPointerException.h"

@implementation JavaIoInputStreamReader

+ (NSArray *)memDebugStaticReferences {
  NSMutableArray *result = [NSMutableArray array];
  return result;
}

- (id)initWithJavaIoInputStream:(JavaIoInputStream *)inArg {
  if ((self = [super initWithId:inArg])) {
    JavaIoInputStreamReader_set_in_(self, inArg);
    encoding_ = 5;
    JreMemDebugAdd(self);
  }
  return self;
}

- (id)initWithJavaIoInputStream:(JavaIoInputStream *)inArg
                   withNSString:(NSString *)enc {
  if ((self = [super initWithId:inArg])) {
    if (enc == nil) {
      @throw [[[JavaLangNullPointerException alloc] init] autorelease];
    }
    JavaIoInputStreamReader_set_in_(self, inArg);
    encoding_ = [JavaIoInputStreamReader getOSXEncodingWithNSString:enc];
    if (encoding_ == -1) {
      @throw [[[JavaIoUnsupportedEncodingException alloc] initWithNSString:enc] autorelease];
    }
    JreMemDebugAdd(self);
  }
  return self;
}

+ (IOSObjectArray *)__exceptions_JavaIoInputStreamReaderWithJavaIoInputStream_withNSString_ {
  return [IOSObjectArray arrayWithObjects:(id[]) { [JavaIoUnsupportedEncodingException getClass] } count:1 type:[IOSClass getClass]];
}

+ (int)getOSXEncodingWithNSString:(NSString *)enc {
  if ([((NSString *) nil_chk(enc)) equalsIgnoreCase:@"ASCII"] || [enc equalsIgnoreCase:@"US-ASCII"]) {
    return 1;
  }
  if ([enc equalsIgnoreCase:@"EUC_JP"]) {
    return 3;
  }
  if ([enc equalsIgnoreCase:@"UTF8"] || [enc equalsIgnoreCase:@"UTF-8"]) {
    return 4;
  }
  if ([enc equalsIgnoreCase:@"8859_1"] || [enc equalsIgnoreCase:@"ISO8859_1"] || [enc equalsIgnoreCase:@"ISO-8859-1"]) {
    return 5;
  }
  if ([enc equalsIgnoreCase:@"ISO8859_2"]) {
    return 9;
  }
  if ([enc equalsIgnoreCase:@"UTF-16"]) {
    return 10;
  }
  if ([enc equalsIgnoreCase:@"UTF-16BE"]) {
    return (int) 0x90000100;
  }
  if ([enc equalsIgnoreCase:@"UTF-16LE"]) {
    return (int) 0x94000100;
  }
  return -1;
}

- (void)close {
  @synchronized (lock_) {
    if (in_ != nil) {
      [in_ close];
      JavaIoInputStreamReader_set_in_(self, nil);
    }
  }
}

+ (IOSObjectArray *)__exceptions_close {
  return [IOSObjectArray arrayWithObjects:(id[]) { [JavaIoIOException getClass] } count:1 type:[IOSClass getClass]];
}

- (NSString *)getEncoding {
  if (![self isOpen]) {
    return nil;
  }
  return [JavaIoInputStreamReader nativeEncodingNameWithInt:encoding_];
}

+ (NSString *)nativeEncodingNameWithInt:(int)encoding   {
    switch (encoding) {
      case NSASCIIStringEncoding:
      return @"ASCII";
      case NSISOLatin1StringEncoding:
      return @"ISO8859_1";
      case NSUTF8StringEncoding:
      return @"UTF8";
      case NSUnicodeStringEncoding:
      return @"UTF-16";
      case NSUTF16BigEndianStringEncoding:
      return @"UnicodeBigUnmarked";
      case NSUTF16LittleEndianStringEncoding:
      return @"UnicodeLittleUnmarked";
      default:
      return nil;
    }
  }

- (int)read {
  @synchronized (lock_) {
    if (![self isOpen]) {
      @throw [[[JavaIoIOException alloc] initWithNSString:@"InputStreamReader is closed."] autorelease];
    }
    IOSCharArray *buf = [IOSCharArray arrayWithLength:1];
    return [self readWithCharArray:buf withInt:0 withInt:1] != -1 ? [buf charAtIndex:0] : -1;
  }
}

+ (IOSObjectArray *)__exceptions_read {
  return [IOSObjectArray arrayWithObjects:(id[]) { [JavaIoIOException getClass] } count:1 type:[IOSClass getClass]];
}

- (int)readWithCharArray:(IOSCharArray *)buf
                 withInt:(int)offset
                 withInt:(int)length {
  @synchronized (lock_) {
    if (![self isOpen]) {
      @throw [[[JavaIoIOException alloc] initWithNSString:@"InputStreamReader is closed."] autorelease];
    }
    if (offset < 0 || offset > (int) [((IOSCharArray *) nil_chk(buf)) count] - length || length < 0) {
      @throw [[[JavaLangIndexOutOfBoundsException alloc] init] autorelease];
    }
    if (length == 0) {
      return 0;
    }
    if (backingStore_ == nil) {
      JavaIoByteArrayOutputStream *byteArray = [[[JavaIoByteArrayOutputStream alloc] init] autorelease];
      IOSByteArray *buffer = [IOSByteArray arrayWithLength:8192];
      int len;
      while ((len = [((JavaIoInputStream *) nil_chk(in_)) readWithByteArray:buffer]) > -1) {
        [byteArray writeWithByteArray:buffer withInt:0 withInt:len];
      }
      JavaIoInputStreamReader_set_backingStore_(self, [self convertToStringWithByteArray:[byteArray toByteArray]]);
      currentIndex_ = 0;
    }
    if (currentIndex_ == [((NSString *) nil_chk(backingStore_)) length]) {
      return -1;
    }
    int n = [JavaLangMath minWithInt:length withInt:[backingStore_ length] - currentIndex_];
    [backingStore_ getChars:currentIndex_ sourceEnd:currentIndex_ + n destination:buf destinationBegin:offset];
    currentIndex_ += n;
    return n;
  }
}

+ (IOSObjectArray *)__exceptions_readWithCharArray_withInt_withInt_ {
  return [IOSObjectArray arrayWithObjects:(id[]) { [JavaIoIOException getClass] } count:1 type:[IOSClass getClass]];
}

- (NSString *)convertToStringWithByteArray:(IOSByteArray *)byteArray   {
    NSUInteger length = [byteArray count];
    char *buffer = malloc(length);
    [byteArray getBytes:buffer offset:0 length:length];
    NSString *result = [[NSString alloc] initWithBytes:buffer length:length encoding:encoding_];
    free(buffer);
    #if ! __has_feature(objc_arc)
    [result autorelease];
    #endif
    return result;
  }

- (BOOL)isOpen {
  return in_ != nil;
}

- (BOOL)ready {
  if (in_ == nil) {
    @throw [[[JavaIoIOException alloc] initWithNSString:@"InputStreamReader is closed."] autorelease];
  }
  return backingStore_ == nil || [backingStore_ length] - currentIndex_ > 0;
}

+ (IOSObjectArray *)__exceptions_ready {
  return [IOSObjectArray arrayWithObjects:(id[]) { [JavaIoIOException getClass] } count:1 type:[IOSClass getClass]];
}

- (void)dealloc {
  JreMemDebugRemove(self);
  JavaIoInputStreamReader_set_backingStore_(self, nil);
  JavaIoInputStreamReader_set_in_(self, nil);
  [super dealloc];
}

- (void)copyAllFieldsTo:(JavaIoInputStreamReader *)other {
  [super copyAllFieldsTo:other];
  JavaIoInputStreamReader_set_backingStore_(other, backingStore_);
  other->currentIndex_ = currentIndex_;
  other->encoding_ = encoding_;
  JavaIoInputStreamReader_set_in_(other, in_);
}

- (NSArray *)memDebugStrongReferences {
  NSMutableArray *result =
      [[[super memDebugStrongReferences] mutableCopy] autorelease];
  [result addObject:[JreMemDebugStrongReference strongReferenceWithObject:in_ name:@"in"]];
  [result addObject:[JreMemDebugStrongReference strongReferenceWithObject:backingStore_ name:@"backingStore"]];
  return result;
}

@end
